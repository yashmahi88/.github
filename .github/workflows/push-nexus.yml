name: Push To Nexus

on:
  workflow_call:
    secrets:
      NEXUS_USERNAME:
        required: true
      NEXUS_PASSWORD:
        required: true
      NEXUS_API_KEY:
        required: true
      NEXUS_DEV_SOURCE:
        required: true
      NEXUS_RELEASE_SOURCE:
        required: true
      NEXUS_TAG_SOURCE:
        required: true

jobs:
  push_to_nexus_tag:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    environment: nexus-approval
    steps:
      - name: Download Package Artifact
        uses: actions/download-artifact@v3
        with:
          name: nuget-package
          path: ~/artifact

      - name: List files in artifact directory
        run: ls -al ~/artifact

      - name: Push to Nexus Repository (Tag)
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          NEXUS_TAG_SOURCE: ${{ secrets.NEXUS_TAG_SOURCE }}
        run: |
          echo "Pushing to Nexus repository for tag: $NEXUS_TAG_SOURCE"
          for file in ~/artifact/*; do
            echo "Pushing file: $file"
            curl -u "$NEXUS_USERNAME:$NEXUS_PASSWORD" --upload-file "$file" "$NEXUS_TAG_SOURCE"
          done

  push_to_nexus_branch:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/release'
    steps:
      - name: Download Package Artifact
        uses: actions/download-artifact@v3
        with:
          name: nuget-package
          path: ~/artifact

      - name: List files in artifact directory
        run: ls -al ~/artifact

      - name: Push to Nexus Repository (Branch)
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          NEXUS_DEV_SOURCE: ${{ secrets.NEXUS_DEV_SOURCE }}
          NEXUS_RELEASE_SOURCE: ${{ secrets.NEXUS_RELEASE_SOURCE }}
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/development" ]]; then
            NEXUS_SOURCE="${NEXUS_DEV_SOURCE}"
          elif [[ "${GITHUB_REF}" == "refs/heads/release" ]]; then
            NEXUS_SOURCE="${NEXUS_RELEASE_SOURCE}"
          fi
          echo "Pushing to Nexus repository: $NEXUS_SOURCE"
          for file in ~/artifact/*; do
            echo "Pushing file: $file"
            curl -u "$NEXUS_USERNAME:$NEXUS_PASSWORD" --upload-file "$file" "$NEXUS_SOURCE"
          done
